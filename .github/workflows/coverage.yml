name: Coverage Enforcement

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  coverage:
    name: Enforce 90% Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with coverage
        run: |
          # Exclude GPU (LLVM can't instrument GPU shaders) and xtask (dev tool)
          # This matches the local `make coverage` behavior
          cargo llvm-cov --workspace --exclude xtask --lcov --output-path lcov.info

      - name: Check coverage threshold (BLOCKS PR if < 90%)
        run: |
          # Get trueno library coverage (excludes GPU shaders and xtask)
          OVERALL=$(cargo llvm-cov report | tail -1 | awk '{print $10}' | sed 's/%//')
          echo "ðŸ“Š Overall coverage: ${OVERALL}%"
          echo "   Note: GPU shaders excluded (LLVM cannot instrument them)"

          if (( $(echo "$OVERALL < 90" | bc -l) )); then
            echo ""
            echo "âŒ COVERAGE CHECK FAILED"
            echo "   Current: ${OVERALL}%"
            echo "   Required: 90%"
            echo "   Gap: $(echo "90 - $OVERALL" | bc)%"
            echo ""
            echo "Run 'make coverage' locally to see detailed report"
            exit 1
          fi

          echo "âœ… Coverage requirement met: ${OVERALL}% â‰¥ 90%"

      - name: Upload coverage to Codecov (optional)
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate coverage HTML report
        if: always()
        run: cargo llvm-cov report --html --output-dir target/coverage/html

      - name: Upload coverage HTML as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/coverage/html/
          retention-days: 30
