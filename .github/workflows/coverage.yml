name: Coverage Enforcement

on:
  pull_request:
  push:
    branches: [main, master]

jobs:
  coverage:
    name: Enforce 90% Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests with coverage
        run: |
          # Exclude GPU (LLVM can't instrument GPU shaders) and xtask (dev tool)
          # This matches the local `make coverage` behavior
          cargo llvm-cov --workspace --exclude xtask --lcov --output-path lcov.info

      - name: Check coverage threshold (BLOCKS PR if < 75% in CI)
        run: |
          # Calculate Trueno library coverage only (excludes xtask dev tool)
          # CI threshold is 75% (vs 90% local) because:
          # - CI runners don't have AVX-512 CPUs, so those code paths aren't taken
          # - AVX-512 backend alone has ~2,400 lines that won't be covered in CI
          # - Local development with AVX-512 CPUs should maintain 90%+ coverage
          cargo llvm-cov report | python3 -c "
          import sys
          lines = list(sys.stdin)
          # Filter to trueno source files only (exclude xtask, TOTAL line, separator lines)
          trueno = [l for l in lines if '.rs' in l and 'xtask' not in l and not l.startswith('TOTAL') and not l.startswith('-')]
          if not trueno:
              print('âŒ No coverage data found')
              sys.exit(1)
          # Parse line counts (columns: Regions, Missed, Cover, Lines, Missed, Cover, Branches, Missed, Cover, Filename)
          # Lines column is at index 7, Missed lines at index 8 (0-indexed after split)
          t_total = sum(int(l.split()[7]) for l in trueno)
          t_uncov = sum(int(l.split()[8]) for l in trueno)
          t_cov = 100*(t_total-t_uncov)/t_total if t_total > 0 else 0
          print(f'ðŸ“Š Trueno library coverage: {t_cov:.2f}%')
          print(f'   Lines: {t_total-t_uncov:,}/{t_total:,}')
          print(f'   Note: GPU shaders and xtask excluded (per project policy)')
          print(f'   Note: CI threshold is 75% (90% local) due to AVX-512 CPU requirements')
          print('')
          # CI uses 75% threshold since AVX-512 code paths aren't taken on CI runners
          CI_THRESHOLD = 75
          if t_cov < CI_THRESHOLD:
              print(f'âŒ COVERAGE CHECK FAILED')
              print(f'   Current: {t_cov:.2f}%')
              print(f'   CI Threshold: {CI_THRESHOLD}%')
              print(f'   Gap: {CI_THRESHOLD-t_cov:.2f}%')
              print('')
              print('Run \"make coverage\" locally to verify 90%+ with full CPU features')
              sys.exit(1)
          print(f'âœ… Coverage requirement met: {t_cov:.2f}% â‰¥ {CI_THRESHOLD}% (CI threshold)')
          print(f'   Note: Local threshold is 90% with AVX-512 support')
          "

      - name: Upload coverage to Codecov (optional)
        if: success()
        uses: codecov/codecov-action@v4
        with:
          files: ./lcov.info
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate coverage HTML report
        if: always()
        run: cargo llvm-cov report --html --output-dir target/coverage/html

      - name: Upload coverage HTML as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/coverage/html/
          retention-days: 30
